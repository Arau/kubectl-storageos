apiVersion: troubleshoot.sh/v1beta2
kind: Preflight
metadata:
  name: StorageOS
spec:
  collectors:
    - clusterResources: {}
    - run:
        collectorName: "run-storageos-cli"
        name: storageos
        image: ubuntu
        namespace: kube-system
        command: 
        - "/bin/sh"
        - "-c"
        - "
          for mod in target_core_mod tcm_loop target_core_file uio target_core_user; do
            state_file=/sys/module/$mod/initstate;
            if [ -f \"$state_file\" ] && grep -q live \"$state_file\"; then
                echo \"Module $mod is present\";
            else 
                echo \"Module $mod is not present\";
            fi;
          done;
        "
        imagePullPolicy: IfNotPresent
  analyzers: 
    - nodeResources:
        checkName: At least one node must have 4 GB RAM and 2 CPU Cores
        filters:
          allocatableMemory: 4Gi
          cpuCapacity: "2"
        outcomes:
          - fail:
              when: count() < 1
              message: Cannot find a node with sufficient memory and cpu
          - pass:
              message: Sufficient CPU and memory is available
    - textAnalyze:
        checkName: "At least one machine running Linux with a 64-bit architecture"
        fileName: cluster-info/cluster_version.json
        regex: linux\/amd64
        outcomes:
          - pass:
              message: Linux with a 64-bit architecture is available.
          - fail:
              message: Linux with a 64-bit architecture is required.
    - clusterVersion:
        outcomes:
          - fail:
              when: "< 1.17.0"
              message: StorageOS requires at least Kubernetes 1.17.0.
          - pass:
              message: Your cluster meets the required versions of Kubernetes.
    - containerRuntime:
        outcomes:
          - pass:
              when: "== cri-o"
              message: CRI-O enabled.
          - pass:
              when: "== containerd"
              message: Containerd enabled.
          - pass:
              when: "== docker"
              message: Docker enabled.
          - fail:
              message: Required Container Runtime is unavailable.
    - nodeResources:
        checkName: At least 3 nodes in the cluster
        outcomes:
          - warn: 
              when: "count() < 3"
              message: It is recommended to have at least 3 nodes for replication and high availability.
          - pass:
              message: There are enough nodes.
    - textAnalyze:
        checkName: Required kernel module target_core_mod
        fileName: storageos/run-storageos-cli.log
        regex: 'Module target_core_mod is present'
        outcomes:
          - pass:
              message: Required kernel module is present.
          - fail:
              message: Required kernel module is not present.
    - textAnalyze:
        checkName: Required kernel module tcm_loop
        fileName: storageos/run-storageos-cli.log
        regex: 'Module tcm_loop is present'
        outcomes:
          - pass:
              message: Required kernel module is present.
          - fail:
              message: Required kernel module is not present.
    - textAnalyze:
        checkName: Required kernel module target_core_file
        fileName: storageos/run-storageos-cli.log
        regex: 'Module target_core_file is present'
        outcomes:
          - pass:
              message: Required kernel module is present.
          - fail:
              message: Required kernel module is not present.
    - textAnalyze:
        checkName: Required kernel module uio
        fileName: storageos/run-storageos-cli.log
        regex: 'Module uio is present'
        outcomes:
          - pass:
              message: Required kernel module is present.
          - fail:
              message: Required kernel module is not present.
    - textAnalyze:
        checkName: Required kernel module target_core_user
        fileName: storageos/run-storageos-cli.log
        regex: 'Module target_core_user is present'
        outcomes:
          - pass:
              message: Required kernel module is present.
          - fail:
              message: Required kernel module is not present.